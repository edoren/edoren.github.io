<!doctype html><html lang=en><head><meta charset=utf-8><meta name=theme-color content="#272727"><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='If you’ve ever used C or C ++ for sure you’ve had to use methods that make your job easier, no one likes to re-invent the wheel (unless you’re a caveman). And is that many times we find cases where we have to do the calculation of a square root with sqrt, or we just want to use printf to print a message on the screen.'><meta name=keywords content="C++,Linux"><meta property="og:title" content='Understanding Dynamic Linking in C++ | Manuel Sabogal'><meta property="og:image" content="https://www.gravatar.com/avatar/fc2e213fc8d2758e7e35017ddd0e2566?s=200"><meta property="og:url" content="https://edoren.me/blog/tutorials/dynamic_library_loading_cpp/"><meta property="og:locale" content="en_US"><meta property="og:locale:alternate" content="es_CO"><meta property="og:type" content="article"><meta property="article:author" content="https://edoren.me/about/"><meta property="og:description" content='If you’ve ever used C or C ++ for sure you’ve had to use methods that make your job easier, no one likes to re-invent the wheel (unless you’re a caveman). And is that many times we find cases where we have to do the calculation of a square root with sqrt, or we just want to use printf to print a message on the screen.'><meta property="article:published_time" content='2017-04-08'><meta property="article:modified_time" content='2024-11-03'><meta property="article:tag" content="C++"><meta property="article:tag" content="Linux"><meta name=twitter:card content="summary"><meta name=twitter:site content="@ItsEdoren"><meta name=twitter:creator content="@ItsEdoren"><meta name=google-site-verification content="V02xVIZZTjhtzvQc3Qwqz0BbBtAYxh0F4sBFXy1Rh_I"><title>Understanding Dynamic Linking in C++ | Manuel Sabogal</title>
<link rel=apple-touch-icon sizes=180x180 href=https://edoren.me/icons/apple-touch-icon.png><link rel=icon type=image/png href=https://edoren.me/icons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://edoren.me/icons/favicon-16x16.png sizes=16x16><link rel=manifest href=https://edoren.me/icons/manifest.json><link rel=stylesheet href=https://edoren.me/scss/style.min.e170117c9442fdb6c1c8261307942a0a0089b47714f6a88883d518c87bef5641.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Amaranth:400,700"><link rel=stylesheet href="//fonts.googleapis.com/css?family=PT+Sans:400,400i,700,700i"><link rel=stylesheet href=//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack-subset.css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.css><link rel=stylesheet href=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.16.2/build/styles/default.min.css><link rel=stylesheet href=https://edoren.me/scss/hljs_custom.min.634bcd06f2eaeadb04b2be550cbcf8aced83d96a84ad8ca506d9169e0166d96a.css><script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.16.2/build/highlight.min.js></script></head><body class=theme-base><section id=sidebar><div class=sidebar-sticky><div class=sidebar-about><a href=https://edoren.me/><img src="https://www.gravatar.com/avatar/fc2e213fc8d2758e7e35017ddd0e2566?s=200" alt=Gravatar title="Manuel Sabogal">
</a><a href=https://edoren.me/><h1>Manuel Sabogal</h1><p class=lead>Software Development</p></a></div><ul class=sidebar-nav><li><a href=https://edoren.me/blog/>Blog</a></li><li><a href=https://edoren.me/about/>About Me</a></li></ul><div class=sidebar-nav-icons><a href=https://twitter.com/ItsEdoren target=_blank><i class="fab fa-twitter"></i></a>
<a href=https://github.com/edoren target=_blank><i class="fab fa-github"></i></a>
<a href=https://gitlab.com/edoren target=_blank><i class="fab fa-gitlab"></i></a>
<a href=https://www.linkedin.com/in/edoren target=_blank><i class="fab fa-linkedin"></i></a>
<a href=mailto:mfer32@gmail.com><i class="fas fa-envelope"></i></a></div><p class=sidebar-copyright>Copyright <i class="fas fa-copyright"></i>&nbsp2024 Manuel Sabogal<br>Powered with <i class="fas fa-heart"></i>&nbspusing <a href=https://gohugo.io target=_blank>Hugo</a> (v0.128.0) and <a href=https://pages.github.com/ target=_blank>GitHub Pages</a><br>Build Version <a href=https://github.com/edoren/edoren.me/commit/372ac7d80d8da616088b877466d75168f1530b05 target=_blank>372ac7d</a></p></div></section><section id=content><article class=post><header><h1 id=title class=post-title>Understanding Dynamic Linking in C++</h1><ul><li><a href=https://edoren.me/blog/tutorials/dynamic_library_loading_cpp/>English</a></li><li><a href=https://edoren.me/es/blog/tutorials/dynamic_library_loading_cpp/>Español</a></li><ul></header><body><p>If you&rsquo;ve ever used C or C ++ for sure you&rsquo;ve had to use methods that make your job easier, no one likes to re-invent the wheel (unless you&rsquo;re a caveman). And is that many times we find cases where we have to do the calculation of a square root with <code>sqrt</code>, or we just want to use <code>printf</code> to print a message on the screen.</p><p>Each time we include this files we are making use of one Library <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, either the C or C++ standard library, or some other of the infinity of libraries that exist on the Internet</p><p>What this libraries do is join as part of the code of our executable by means of and operation called Linking <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. There are two ways we can perform this process, in compiling time and in run time.</p><p>For reasons of this tutorial we will focus on the second one, but I will still explain how the compiler perform this process.</p><h2 id=in-compile-time>In Compile Time</h2><p>If use Linux and have ever compiled from the console any program that uses threads, you will know the following command:</p><pre><code class=language-bash>gcc myprogram.c -o myprogram -lpthread
</code></pre><p>Do you recognize it?, well in this case what we are doing is linking a library in compile time. When we add the <code>-lpthread</code> line we are telling the compiler that we are going to use a library called <strong>pthread</strong>, which is the POSIX library for handling threads <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><p>What the compiler does when adding this line is that it search in certain directories of the system if that library is found to later resolve al the symbols (functions, variables, or objects) used by it. In Linux it searchs for files of the form <em>lib<strong>name</strong>.so</em> or <em>lib<strong>name</strong>.a</em> for dynamic and static libraries respectively. In this speficic case it uses the library <em><strong>libpthread.so</strong></em>.</p><h2 id=in-run-time>In Run Time</h2><p>Another alternative to make use this libraries, is loading them in run time, through dynamic libraries (<code>.so</code> in Linux, <code>.dll</code> in Windows or <code>.dylib</code> in Mac OS X).</p><p>In order to do this we have to make use of libraries that the system provides, in this case we will make use of the header <code>&lt;dlfcn.h></code> that we can find in Linux and Mac OSX. In Windows there is similar alternative that is found in the header<code>&lt;windows.h></code> <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><h3 id=creating-our-first-library>Creating Our First Library</h3><p>The first thing we are going to do is create a dynamic library that will serve as an example. For that we will use the following code:</p><pre><code class=language-c++>#include &quot;HelloLibrary.hpp&quot;
#include &lt;iostream&gt;

void SayHello(const char* name) {
    std::cout &lt;&lt; &quot;Hello &quot; &lt;&lt; name &lt;&lt; &quot; have a nice day!&quot; &lt;&lt; std::endl;
}
</code></pre><p>File <em>HelloLibrary.cpp</em></p><p>What we have just done is create function that given a string it&rsquo;s going to print a greeting message. If we take a look at the code we will se that is includes a file called <em><strong>HelloLibrary.hpp</strong></em> which has the following content:</p><pre><code class=language-c++>#pragma once

#ifdef  __cplusplus
extern &quot;C&quot; {
#endif

void SayHello(const char* name);

#ifdef  __cplusplus
}
#endif
</code></pre><p>File <em>HelloLibrary.hpp</em></p><p>Now we are going to compile and generate our own dynamic library:</p><pre><code class=language-bash>g++ HelloLibrary.cpp -o libHelloLibrary.so -shared -fPIC
</code></pre><blockquote><p>NOTE: If you are in Ubuntu or Debian you should probably execute the following command in order to install the C and C++ compiler: <code>sudo apt-get install build-essential</code></p></blockquote><p>What just happened here?, well, we are telling the compiler that we want to compile the file <em><strong>HelloLibrary.cpp</strong></em> and generate a library called <em><strong>HelloLibrary.so</strong></em>, additionaly we are providing two more parameters, <code>-shared</code> tells the compiler that we want to create a shared object which can later be linked with other objects to form an executable, <code>-fPIC</code> tells the compiler to emit position-independent code (PIC)<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup> which is necessary to create a dynamic library.</p><h3 id=using-our-library>Using Our Library</h3><p>Now have just generated our first library, but how do we use it?. We are going to make use of the functions <code>dlopen</code>, <code>dlclose</code> y <code>dlsym</code> which have the following definition:</p><pre><code class=language-c++>void* dlopen(const char* filename, int flag);
int dlclose(void* handle);
void* dlsym(void* handle, const char* symbol);
</code></pre><blockquote><p>We can read more about this libraries in the Linux manuals, by executing the command <code>man [función]</code>. E.g. <code>man dlopen</code>.</p></blockquote><p>We need to load the library we created in our program, for this we are will use of <code>dlopen</code>:</p><pre><code class=language-c++>void* handle = dlopen(&quot;libHelloLibrary.so&quot;, RTLD_LAZY);
</code></pre><p>If this function executes correctly <code>handle</code> will point to our librería, if it fails it will be set to <code>NULL</code>.</p><p>Now we are going to load the function <code>SayHello</code> that we declared early, using <code>dlsym</code> as follows:</p><pre><code class=language-c++>PFN_SAY_NAME hello = reinterpret_cast&lt;PFN_SAY_NAME&gt;(dlsym(handle, &quot;SayHello&quot;));
</code></pre><p>Wow, wow!, what just happened?, what is that type <code>PFN_SAY_NAME</code>?. Since <code>dlsym</code> returns a pointer of type <code>void*</code>, and what we need is a pointer to a function, we must have a type that allows us detect what function we are pointing to (what parameters it requires and what does it returns), to do so we declare this type as follows:</p><pre><code class=language-c++>typedef void (*PFN_SAY_NAME)(const char*);

// In C++11 it's easier if you have the function declaration
using PFN_SAY_NAME = decltype(&amp;SayHello);
</code></pre><p>Now we just have to call our function and close our library:</p><pre><code class=language-c++>hello(&quot;Edoren&quot;);
dlclose(handle);
</code></pre><h4 id=all-together>All Together:</h4><pre><code class=language-c++>#include &quot;HelloLibrary.hpp&quot;
#include &lt;iostream&gt;
#include &lt;dlfcn.h&gt;

typedef void (*PFN_SAY_NAME)(const char*);

int main(void) {
    void* handle = dlopen(&quot;libHelloLibrary.so&quot;, RTLD_LAZY);
    if (!handle) {    
        std::cout &lt;&lt; &quot;Could not open the library&quot; &lt;&lt; std::endl;
        return 1;
    }

    PFN_SAY_NAME hello = reinterpret_cast&lt;PFN_SAY_NAME&gt;(dlsym(handle, &quot;SayHello&quot;));
    if (!hello) {
        std::cout &lt;&lt; &quot;Could not find symbol SayHello&quot; &lt;&lt; std::endl;
        dlclose(handle);
        return 1;
    }

    hello(&quot;Edoren&quot;);
    dlclose(handle);

    return 0;
}
</code></pre><p>File <em>LoadLibrary.cpp</em></p><p>Additionaly I added some code to verify posible errors that could arise.</p><p>Finally we copile and execute our code as follows:</p><pre><code class=language-bash>g++ -std=c++11 LoadLibrary.cpp -o LoadLibrary.bin -ldl
./LoadLibrary.bin
</code></pre><p>If you look carefully at the compilation command we are making use of the <code>dl</code> library which contains the functions we previously used.</p><p>If you have reached this part I hope that this tutorial has been useful and you could have clearly understood the concept. You can find the source code of this tutorial on my <a href=https://github.com/edoren/BlogCodes/tree/master/dynamic_library_loading_cpp>GitHub</a> repository</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://en.wikipedia.org/wiki/Library_(computing)>https://en.wikipedia.org/wiki/Library_(computing)</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://en.wikipedia.org/wiki/Linker_(computing)>https://en.wikipedia.org/wiki/Linker_(computing)</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://en.wikipedia.org/wiki/POSIX_Threads>https://en.wikipedia.org/wiki/POSIX_Threads</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684175(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/ms684175(v=vs.85).aspx</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://en.wikipedia.org/wiki/Position-independent_code>https://en.wikipedia.org/wiki/Position-independent_code</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></body><footer><hr><div id=meta><div class=info-column><div><strong>Information</strong></div><div>Apr 8, 2017</div><div>1000 Words</div></div><div class=categories-column><div><strong>Categories</strong></div><ul><li><a href=https://edoren.me/categories/tutorials>Tutorials</a></li></ul></div><div class=tags-column><div><strong>Tags</strong></div><a class=label href=https://edoren.me/tags/c++>#c++</a>
<a class=label href=https://edoren.me/tags/linux>#linux</a></div></div><div id=sharelinks><div><strong>Share On</strong></div><a class="share-button twitter" href='https://twitter.com/intent/tweet?text=Understanding%20Dynamic%20Linking%20in%20C%2b%2b https%3a%2f%2fedoren.me%2fblog%2ftutorials%2fdynamic_library_loading_cpp%2f' target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i> Twitter</a>
<a class="share-button facebook" href='https://www.facebook.com/sharer/sharer.php?t=Understanding%20Dynamic%20Linking%20in%20C%2b%2b&u=https%3a%2f%2fedoren.me%2fblog%2ftutorials%2fdynamic_library_loading_cpp%2f' target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i> Facebook</a>
<a class="share-button linkedin" href='https://linkedin.com/shareArticle?mini=true&title=Understanding%20Dynamic%20Linking%20in%20C%2b%2b&url=https%3a%2f%2fedoren.me%2fblog%2ftutorials%2fdynamic_library_loading_cpp%2f' target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i> LinkedIn</a>
<a class="share-button reddit" href='https://reddit.com/submit?title=Understanding%20Dynamic%20Linking%20in%20C%2b%2b&url=https%3a%2f%2fedoren.me%2fblog%2ftutorials%2fdynamic_library_loading_cpp%2f' target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i> Reddit</a></div><hr><section id=comments><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://edoren.me/blog/tutorials/dynamic_library_loading_cpp/",this.page.identifier="72b0b949-23fe-4bba-b86d-3a0815083034"};(function(){var e=document,t=e.createElement("script");t.src="https://edoren.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></section></footer></article></div><script type=text/javascript>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-49027257-3","auto"),ga("send","pageview")</script><script src=https://edoren.me/js/highlightjs-line-numbers.js></script><script>hljs.initHighlightingOnLoad(),hljs.initLineNumbersOnLoad()</script><script src=https://edoren.me/js/coliru.js></script><script>window.onload=coliru.addRunButtonsToCodeBlocks</script></body></html>